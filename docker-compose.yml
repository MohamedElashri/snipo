services:
  snipo:
    image: ghcr.io/mohamedelashri/snipo:latest
    container_name: snipo
    restart: unless-stopped
    # Security: Container runs as non-root user (UID 1000) with:
    # - Read-only root filesystem
    # - All Linux capabilities dropped
    # - No privilege escalation allowed
    ports:
      - "8080:8080"
    volumes:
      - snipo_data:/data
      # Temporary directory for read-only root filesystem
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: 10485760  # 10MB
          mode: 1777
    # Security options
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    # User mapping (runs as UID 1000 inside container)
    user: "1000:1000"
    environment:
      # Authentication: Use either hashed password (recommended) or plain password
      # Generate hash with: docker run --rm ghcr.io/mohamedelashri/snipo:latest hash-password your-password
      # SNIPO_MASTER_PASSWORD_HASH=${SNIPO_MASTER_PASSWORD_HASH}
      # OR use plain password (backward compatible, less secure)
      - SNIPO_MASTER_PASSWORD=${SNIPO_MASTER_PASSWORD:-<Put_your_master_password_here>}
      # Required: Set a random session secret (generate with: openssl rand -hex 32)
      - SNIPO_SESSION_SECRET=${SNIPO_SESSION_SECRET:-<generate_with_openssl_rand_hex_32>}
      # Recommended: Encryption salt for backups and GitHub token storage (generate with: openssl rand -base64 32)
      # IMPORTANT: Required for GitHub Gist sync feature to persist across restarts
      # - SNIPO_ENCRYPTION_SALT=${SNIPO_ENCRYPTION_SALT:-<generate_with_openssl_rand_base64_32>}
      # Optional: Session duration
      # - SNIPO_SESSION_DURATION=168h
      # Optional: Server configuration
      - SNIPO_HOST=0.0.0.0
      - SNIPO_PORT=8080
      # - SNIPO_TRUST_PROXY=false
      # - SNIPO_BASE_PATH=/snipo  # For reverse proxy subpath deployment
      # - SNIPO_MAX_FILES_PER_SNIPPET=10
      - SNIPO_LOG_LEVEL=info
      - SNIPO_LOG_FORMAT=json
      # Optional: Database configuration
      # - SNIPO_DB_PATH=/data/snipo.db
      # - SNIPO_DB_MAX_CONNS=1
      # - SNIPO_DB_BUSY_TIMEOUT=5000
      # - SNIPO_DB_JOURNAL=WAL
      # - SNIPO_DB_SYNC=NORMAL
      # Optional: Database memory settings (adjust based on system resources)
      # Reduce these values if experiencing "out of memory" database errors
      # - SNIPO_DB_MMAP_SIZE=268435456    # 256MB memory-mapped I/O
      # - SNIPO_DB_CACHE_SIZE=-2000        # 2MB cache (negative value = KB)
      # For systems with memory constraints, try:
      # - SNIPO_DB_MMAP_SIZE=67108864     # 64MB
      # - SNIPO_DB_CACHE_SIZE=-1000       # 1MB
      # Optional: Authentication rate limiting
      # - SNIPO_RATE_LIMIT=100
      # - SNIPO_RATE_WINDOW=1m
      # Optional: API rate limiting (requests per hour)
      - SNIPO_RATE_LIMIT_READ=1000
      - SNIPO_RATE_LIMIT_WRITE=500
      - SNIPO_RATE_LIMIT_ADMIN=100
      # Optional: CORS configuration (comma-separated origins or * for dev)
      # - SNIPO_ALLOWED_ORIGINS=http://localhost:3000,https://app.example.com
      # Optional: Feature flags
      - SNIPO_ENABLE_PUBLIC_SNIPPETS=true
      - SNIPO_ENABLE_API_TOKENS=true
      - SNIPO_ENABLE_BACKUP_RESTORE=true
      # Optional: S3 backup configuration
      # - SNIPO_S3_ENABLED=true
      # - SNIPO_S3_ENDPOINT=s3.amazonaws.com
      # - SNIPO_S3_ACCESS_KEY=access-key
      # - SNIPO_S3_SECRET_KEY=secret-key
      # - SNIPO_S3_BUCKET=bucket-name
      # - SNIPO_S3_REGION=us-east-1
      # - SNIPO_S3_SSL=true
    healthcheck:
      test: ["CMD", "/snipo", "health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s

volumes:
  snipo_data:
    driver: local
